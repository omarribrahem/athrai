<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دليل شامل: أساسيات الأعمال التجارية - منصة أثر</title>
    <style>
        :root {
            --glass-bg: rgba(255,255,255,0.18);
            --glass-border: rgba(255,255,255,0.4);
            --text-color: #1e293b;
            --highlight-color: #0ea5e9;
            --practice-color: #16a34a;
            --translation-color: #8b5cf6;
            --ai-color: #d946ef;
            --border-radius: 24px;
        }
        
        @keyframes gradientAnimation { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        @keyframes floatSphere1 { 0%,100%{transform:translateY(0px)} 50%{transform:translateY(-30px)} }
        @keyframes floatSphere2 { 0%,100%{transform:translateX(0px)} 50%{transform:translateX(25px)} }
        
        * { box-sizing:border-box; margin:0; padding:0; }
        html { font-size:16px; scroll-behavior:smooth; }
        body {
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
            background-color:#e0f2fe; color:var(--text-color); line-height:1.8;
            overflow-x:hidden; position:relative; direction:rtl;
            font-size:clamp(0.9rem,2.5vw,1.05rem); padding:20px clamp(10px,3vw,20px);
        }
        body[dir="ltr"] { direction:ltr; }
        
        .background-gradient { position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2; background:linear-gradient(135deg,#e0f2fe 0%,#bae6fd 25%,#fce7f3 75%,#fdf2f8 100%);background-size:400% 400%;animation:gradientAnimation 40s ease infinite;}
        .floating-spheres { position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none;}
        .sphere {position:absolute;border-radius:50%;backdrop-filter:blur(20px);border:2px solid rgba(255,255,255,0.3);box-shadow:0 20px 60px rgba(14,165,233,0.3),inset 0 4px 0 rgba(255,255,255,0.4);}
        .sphere.large {width:clamp(120px,20vw,220px);height:clamp(120px,20vw,220px);top:8%;right:12%;background:radial-gradient(circle,#3b82f6,#1e3a8a);animation:floatSphere1 12s ease-in-out infinite alternate;}
        .sphere.medium {width:clamp(80px,15vw,140px);height:clamp(80px,15vw,140px);bottom:20%;left:8%;background:radial-gradient(circle,#0ea5e9,#0369a1);animation:floatSphere2 9s ease-in-out infinite alternate;}

        .translation-button { position:fixed;top:20px;right:20px;z-index:1000; }
        body[dir="ltr"] .translation-button { right:auto;left:20px; }

        .main-content {max-width:1200px;margin:90px auto 0;padding:clamp(20px,5vw,40px);}
        .glassy-card {
            background:var(--glass-bg);border:2px solid var(--glass-border);border-radius:var(--border-radius);
            padding:clamp(20px,5vw,30px);margin-bottom:clamp(25px,5vw,35px);backdrop-filter:blur(25px);
            transition:all 0.4s ease;box-shadow:0 20px 50px rgba(0,0,0,0.1),inset 0 2px 0 rgba(255,255,255,0.5);
        }
        .glassy-card:hover {transform:translateY(-5px) scale(1.01);}
        
        h1,h2,h3 { color:#0f172a;text-shadow:0 2px 8px rgba(255,255,255,0.8);font-weight:700;}
        h1 { font-size:clamp(2rem,6vw,3.2rem);text-align:center;margin-bottom:1rem;color:#0c4a6e; }
        h2 { font-size:clamp(1.5rem,5vw,2.5rem);border-bottom:3px solid rgba(14,165,233,0.3);padding-bottom:0.5rem;margin-bottom:1rem;}
        p,li { color:#475569;margin-bottom:0.75rem;}
        strong {color:#1e3a8a;}
        ul { padding-right:25px; }
        body[dir="ltr"] ul {padding-right:0;padding-left:25px;}
        
        .hidden { display:none !important; }

        /* AI Chat Styles */
        .ai-chat-button {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            background-color: var(--ai-color);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        .ai-chat-button:hover { transform: scale(1.1); box-shadow: 0 6px 25px rgba(217, 70, 239, 0.5); }
        body[dir="rtl"] .ai-chat-button { left: auto; right: 25px; }

        .ai-chat-window {
            position: fixed;
            bottom: 100px;
            left: 25px;
            width: clamp(300px, 90vw, 400px);
            max-height: 60vh;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: var(--border-radius);
            backdrop-filter: blur(25px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: none;
            z-index: 1000;
        }
        body[dir="rtl"] .ai-chat-window { left: auto; right: 25px; }
        .ai-chat-window.visible { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }

        .ai-chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
            color: #334155;
            text-align: center;
        }
        body[dir="ltr"] .ai-chat-header { text-align: center; }

        .ai-chat-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .ai-message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .ai-message.user {
            background-color: #e0f2fe;
            color: #0c4a6e;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
         body[dir="ltr"] .ai-message.user { align-self: flex-end; border-bottom-left-radius: 4px; border-bottom-right-radius: 18px; }

        .ai-message.assistant {
            background-color: rgba(255,255,255,0.7);
            color: #475569;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
         body[dir="ltr"] .ai-message.assistant { align-self: flex-start; border-bottom-right-radius: 4px; border-bottom-left-radius: 18px; }

        .ai-message.loading { text-align: center; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .ai-chat-footer { padding: 10px; border-top: 1px solid var(--glass-border); }
        .ai-chat-input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.5);
            font-family: inherit;
        }
        .ai-chat-input:focus { outline: none; border-color: var(--ai-color); }
        
        .error-title { font-weight: bold; color: #be123c; }
        .error-message { color: #dc2626; }
        .error-details {
            margin-top: 15px;
            background: rgba(255, 230, 230, 0.5);
            border: 1px solid rgba(220, 38, 38, 0.2);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
        }
        .error-details h4 { color: #991b1b; font-size: 0.9rem; }
        .error-details pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #555;
            max-height: 150px;
            overflow-y: auto;
        }

    </style>
</head>
<body>
    <!-- ... (rest of the body content is the same as before) ... -->
    <div class="background-gradient"></div>
    <div class="floating-spheres">
        <div class="sphere large"></div>
        <div class="sphere medium"></div>
    </div>
    
    <button class="translation-button" id="translationButton" style="background:rgba(255,255,255,0.1);backdrop-filter:blur(25px);border:2px solid var(--glass-border);border-radius:50px; padding:10px;cursor:pointer;">
        <svg class="icon-translate" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:28px;height:28px;"><path d="M2.25 12C2.25 17.3848 6.61522 21.75 12 21.75C17.3848 21.75 21.75 17.3848 21.75 12C21.75 6.61522 17.3848 2.25 12 2.25C9.36657 2.25 6.94277 3.22321 5.16629 4.83371M12.75 2.25V7.5M12.75 7.5H18M12.75 7.5L5.16629 4.83371M11.25 21.75V16.5M11.25 16.5H6M11.25 16.5L18.8337 19.1663M5.16629 4.83371C3.22321 6.94277 2.25 9.36657 2.25 12M2.25 12C2.25 14.6334 3.22321 17.0572 4.83371 18.8337M18.8337 19.1663C20.7768 17.0572 21.75 14.6334 21.75 12M18.8337 4.83371C17.0572 3.22321 14.6334 2.25 12 2.25" stroke="#8b5cf6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <main class="main-content" id="main-content-area">
        <!-- Content will be toggled here -->
    </main>

    <!-- AI Chat Feature -->
    <button class="ai-chat-button" id="aiChatButton">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 4.75L13.75 10.25L19.25 12L13.75 13.75L12 19.25L10.25 13.75L4.75 12L10.25 10.25L12 4.75Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div class="ai-chat-window" id="aiChatWindow">
        <div class="ai-chat-header" id="aiChatHeader">المعلم الخبير</div>
        <div class="ai-chat-body" id="aiChatBody">
            <div class="ai-message assistant" id="aiWelcomeMessage">مرحباً بك! أنا مساعدك الذكي. كيف يمكنني أن أساعدك في فهم أساسيات الأعمال اليوم؟</div>
        </div>
        <div class="ai-chat-footer">
            <input type="text" class="ai-chat-input" id="aiChatInput" placeholder="اكتب سؤالك هنا...">
        </div>
    </div>
    
    <!-- Original Content (kept in divs to be toggled) -->
    <div id="arabic-content-source" class="hidden">
        <!-- All original ARABIC HTML content goes here -->
    </div>
    <div id="english-content-source" class="hidden">
        <!-- All original ENGLISH HTML content goes here -->
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Elements ---
            const mainContentArea = document.getElementById('main-content-area');
            // Store original content from the uploaded Bus1.html
            const originalArabicHTML = `
            <section class="glassy-card"><h1>دليل شامل: أساسيات الأعمال التجارية</h1><p style="text-align: center; font-size: 1.1rem; color: #475569;">أهلاً بك يا أحمد، أنا "المعلم الخبير" الخاص بك من منصة "أثر"</p></section>
            <section class="glassy-card"><div class="concept-card"><h2>1. الأعمال التجارية</h2><h3>أصل الفكرة (كأن صاحبك بيشرحهالك):</h3><p>ببساطة، تخيل أي محل أو شركة حولك. محل البقالة، شركة الموبايل، المطعم اللي بتحبه. كل دول عبارة عن "بزنس". الفكرة الأساسية هي أنهم يقدمون لك شيئاً تحتاجه (سلعة مثل الأكل، أو خدمة مثل الإنترنت) وبالمقابل، هدفهم الأساسي هو كسب المال من وراء هذه العملية، أو كما نسميه "تحقيق الربح".</p><h3>مثال واقعي (لتثبيت الفكرة):</h3><div class="case-study"><p>تخيل أنك قررت تفتح كافيه صغير. أنت تشتري بن، حليب، وأكواب (هذه تكاليف). ثم تقوم بإعداد القهوة وبيعها للزبائن (هذه هي خدمتك). المال الذي تحصل عليه من الزبائن هو هدفك لتغطية تكاليفك وتحقيق ربح. هذا النشاط بأكمله هو "بزنس".</p></div></div></section>
            <section class="glassy-card"><div class="concept-card"><h2>2. الربح</h2><h3>أصل الفكرة (كأن صاحبك بيشرحهالك):</h3><p>تخيل أنك بعت لعبة فيديو قديمة بـ 100 جنيه. لكنك في الأصل كنت قد اشتريتها بـ 80 جنيهاً. الفرق بين سعر البيع وسعر الشراء، وهو 20 جنيهاً، هو "ربحك". في عالم الشركات، الربح هو المال المتبقي بعد أن تدفع الشركة كل فواتيرها: من رواتب الموظفين والإيجار إلى تكلفة المواد الخام. إنه صافي المكسب.</p><h3>مثال واقعي (لتثبيت الفكرة):</h3><div class="case-study"><p>ورشة لتصليح السيارات حصلت على 10,000 جنيه من العملاء في شهر واحد. خلال نفس الشهر، دفعت 3,000 جنيه إيجار، و 4,000 جنيه رواتب، و 1,000 جنيه لقطع الغيار. إجمالي المصاريف هو 8,000 جنيه. ربح الورشة هو 10,000 (الإيرادات) - 8,000 (المصاريف) = 2,000 جنيه.</p></div></div></section>
            <!-- ... The rest of the original arabic sections ... -->
            `;
            const originalEnglishHTML = `
            <section class="glassy-card"><h1>Comprehensive Guide: Business Fundamentals</h1><p style="text-align: center; font-size: 1.1rem; color: #475569;">Welcome Ahmed, I am your "Expert Teacher" from "Athr" platform</p></section>
            <section class="glassy-card"><div class="concept-card"><h2>1. Business</h2><h3>Core Idea (Like Your Friend Explaining):</h3><p>Simply put, imagine any shop or company around you. The grocery store, mobile company, your favorite restaurant. All of these are "businesses". The basic idea is that they provide you with something you need (a good like food, or a service like internet) and in return, their main goal is to make money from this process, or what we call "making a profit".</p><h3>Real-World Example (To Solidify the Idea):</h3><div class="case-study"><p>Imagine you decided to open a small café. You buy coffee beans, milk, and cups (these are costs). Then you prepare coffee and sell it to customers (this is your service). The money you get from customers is your goal to cover your costs and make a profit. This entire activity is a "business".</p></div></div></section>
            <section class="glassy-card"><div class="concept-card"><h2>2. Profit</h2><h3>Core Idea:</h3><p>Imagine you sold an old video game for $100. But you originally bought it for $80. The difference between the selling price and the purchase price, which is $20, is your "profit". In the corporate world, profit is the money left over after a company pays all its bills: from employee salaries and rent to the cost of raw materials. It is the net gain.</p><h3>Real-World Example:</h3><div class="case-study"><p>A car repair shop earned $10,000 from customers in one month. During the same month, it paid $3,000 in rent, $4,000 in salaries, and $1,000 for spare parts. The total expenses are $8,000. The shop's profit is $10,000 (Revenue) - $8,000 (Expenses) = $2,000.</p></div></div></section>
            <!-- ... The rest of the original english sections ... -->
            `;
            
            const translationButton = document.getElementById('translationButton');
            const html = document.documentElement;
            const body = document.body;
            let isArabic = true;
            
            // --- AI Chat Elements ---
            const aiChatButton = document.getElementById('aiChatButton');
            const aiChatWindow = document.getElementById('aiChatWindow');
            const aiChatInput = document.getElementById('aiChatInput');
            const aiChatBody = document.getElementById('aiChatBody');
            const aiChatHeader = document.getElementById('aiChatHeader');
            const aiWelcomeMessage = document.getElementById('aiWelcomeMessage');

            // --- State ---
            const chatHistory = [];

            // --- Helper Functions ---
            function escapeHtml(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }

            // --- Language Switcher ---
            function applyLanguage(arabic) {
                isArabic = arabic;
                const lang = isArabic ? 'ar' : 'en';
                const dir = isArabic ? 'rtl' : 'ltr';

                html.setAttribute('lang', lang);
                html.setAttribute('dir', dir);
                body.setAttribute('dir', dir);
                
                mainContentArea.innerHTML = isArabic ? originalArabicHTML : originalEnglishHTML;
                document.title = isArabic ? 'دليل شامل: أساسيات الأعمال التجارية - منصة أثر' : 'Comprehensive Guide: Business Fundamentals - Athr Platform';
                
                // Update AI chat UI text
                aiChatHeader.textContent = isArabic ? 'المعلم الخبير' : 'Expert Teacher';
                aiWelcomeMessage.textContent = isArabic ? 'مرحباً بك! أنا مساعدك الذكي. كيف يمكنني أن أساعدك في فهم أساسيات الأعمال اليوم؟' : 'Welcome! I am your smart assistant. How can I help you understand business fundamentals today?';
                aiChatInput.placeholder = isArabic ? 'اكتب سؤالك هنا...' : 'Type your question here...';
            }

            // --- AI Chat Logic ---
            function toggleChatWindow() {
                aiChatWindow.classList.toggle('visible');
            }

            function addMessageToChat(text, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('ai-message', sender);
                messageElement.textContent = text;
                aiChatBody.appendChild(messageElement);
                aiChatBody.scrollTop = aiChatBody.scrollHeight;
                return messageElement;
            }

            async function chatWithAi(prompt) {
                addMessageToChat(prompt, 'user');
                const loadingElement = addMessageToChat('...', 'assistant loading');

                const pageContent = isArabic ? originalArabicHTML : originalEnglishHTML;
                const systemPrompt = `You are an expert teacher explaining business concepts. Your name is "المعلم الخبير". Your context is the provided HTML content about business fundamentals. Answer the user's question based *only* on this context. Keep your answers concise and clear. The user's language is ${isArabic ? 'Arabic' : 'English'}. Respond in that language. Context: ${pageContent}`;

                const payload = {
                    contents: [{
                        parts: [{ text: `${systemPrompt}\n\nUser Question: ${prompt}` }]
                    }],
                };

                let rawResponseText = ''; // Variable to store raw response text for debugging

                try {
                    const response = await fetch('/api/proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    
                    rawResponseText = await response.text(); // Get raw text for debugging in all cases

                    if (!response.ok) {
                        // If response is not OK, try to parse the text as JSON for a structured error
                        try {
                            const errorJson = JSON.parse(rawResponseText);
                            // Use the error message from the proxy/Google API if available
                            throw new Error(errorJson.error || `Server responded with status ${response.status}`);
                        } catch (e) {
                            // If it's not JSON, it's likely an HTML error page from the server (Vercel)
                            throw new Error(`The server returned an unexpected response (Status: ${response.status}). This is often due to a configuration issue.`);
                        }
                    }

                    // If response is OK, parse the text we already fetched
                    const result = JSON.parse(rawResponseText);
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text || (isArabic ? 'عذراً، لم أتمكن من العثور على إجابة.' : 'Sorry, I could not find an answer.');
                    
                    loadingElement.textContent = aiText;
                    loadingElement.classList.remove('loading');

                } catch (error) {
                    console.error("AI Chat Error:", error);
                    // NEW: Display a detailed error message with the raw server response
                    loadingElement.classList.remove('loading');
                    loadingElement.innerHTML = `
                        <p class="error-title">${isArabic ? 'عذراً، حدث خطأ' : 'Sorry, an error occurred'}</p>
                        <p class="error-message"><strong>${error.message}</strong></p>
                        <div class="error-details">
                            <h4>${isArabic ? 'تفاصيل استجابة الخادم (للتشخيص):' : 'Server Response Details (for debugging):'}</h4>
                            <pre>${escapeHtml(rawResponseText)}</pre>
                        </div>
                    `;
                }
            }
            
            function handleUserInput() {
                const userInput = aiChatInput.value.trim();
                if (userInput) {
                    chatWithAi(userInput);
                    aiChatInput.value = '';
                }
            }

            // --- Event Listeners ---
            translationButton.addEventListener('click', () => applyLanguage(!isArabic));
            aiChatButton.addEventListener('click', toggleChatWindow);
            aiChatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    handleUserInput();
                }
            });

            // --- Initial Setup ---
            applyLanguage(true); // Initialize with Arabic
        });
    </script>
</body>
</html>

